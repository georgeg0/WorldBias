###### Reading raw data files (spss) to convert it to csv ######

# Citation for data
# Xu, K., Nosek, B., & Greenwald, A. (2014). Psychology data from the race implicit association test on the project implicit demo website. Journal of Open Psychology Data, 2(1).
# openpsychologydata.metajnl.com/articles/10.5334/jopd.ac/ 

# visit https://osf.io/52qxl/ to acquire the following data files
# 'Race IAT.public.2004.sav',
# 'Race IAT.public.2009.sav',
# 'Race IAT.public.2014.sav',
# 'Race IAT.public.2011.sav',
# 'Race IAT.public.2013.sav',
# 'Race IAT.public.2008.sav',
# 'Race IAT.public.2012.sav',
# 'Race IAT.public.2010.sav',
# 'Race IAT.public.2005.sav',
# 'Race IAT.public.2006.sav',
# 'Race IAT.public.2015.sav',
# 'Race IAT.public.2007.sav'

# Specify location of these files below, by setting dataloc variable


library(foreign)

# ---------- Setting Path
if(Sys.info()[[4]]=="tom-vaio") {
  setwd("/home/tom/Desktop/Dropbox/WorldBias") #tom's laptop
  dataloc='/home/tom/Desktop/Dropbox/university/expts/WorldBias/data/raw'
} else if (Sys.info()[[4]]=="oli-desktop") {
  setwd("/home/tom/Dropbox/WorldBias") #tom's laptop
  dataloc='/home/tom/Dropbox/university/expts/WorldBias/data/raw'
} else { 
  setwd("/george/Desktop/RACIAL-IAT/")
  dataloc='/george/Desktop/RACIAL-IAT/'
}

# ---------- load raw data
#dataset1 = read.spss(file.path(dataloc,'Race IAT.public.2015.sav'), to.data.frame=TRUE)

if(!require(memisc)){install.packages('memisc')} 
library("memisc")
dataset1 <- data.frame(as.data.set(spss.system.file(file.path(dataloc,'Race IAT.public.2015.sav'))))

#Get the fields that you are interested in
dd <- dataset1[,c("D_biep.White_Good_all","countrycit","countryres")]
write.csv(dd, file=file.path('data','Race.IAT.public.2015.csv'))

print("stopped")
stop()
print("you shouldn't see this")
###### cleaning the file for unwanted entries in countrycit ######

library(plyr)
setwd("/Users/george/Desktop/pjt/RACIAL-IAT/CSV/2014-2015/")
df <- read.csv("Race.IAT.public.2015.csv", header=TRUE)
df2 <- df[!df$countrycit %in% c(". ","  ",".",".   ","    "),]
## removing an unwanted column carried over
cols.dont.want <- "X"
df3 <- df2[, ! names(df2) %in% cols.dont.want, drop = F]
write.csv(df3, "cleansed/Race.IAT.public.cleansed.2015.csv", row.names=FALSE, quote=FALSE)
count(df2, 'countrycit')

###### Combining ######

# This code is for merging the csv file
# Make sure to put all the files in a folder
setwd("/george/Desktop/pjt/RACIAL-IAT/CSV/cleansed2004-2015")
files <- list.files(pattern = "\\.csv$")
DF <-  read.csv(files[1])
for (f in files[-1]) DF <- rbind(DF, read.csv(f))   
write.csv(DF, "Race.IAT.2004-2015.csv", row.names=FALSE, quote=FALSE)

###### Getting the stats ######

setwd("/george/Desktop/pjt/RACIAL-IAT/CSV/cleansed2004-2015")
df <- read.csv("Race.IAT.2004-2015.csv", header=TRUE)
count(df, 'countrycit')

###### Remove the white spaces infront of countrycodes ######

setwd("/george/pjt/RACIAL-IAT/CSV/cleansed2004-2015")
df <- read.csv("Race.IAT.2004-2015.csv", header=TRUE)
df <- data.frame(lapply(df, trimws))
write.csv(df, "Race.IAT.2004-2015.cleansed.csv", row.names=FALSE, quote=FALSE)
dff <- count(df, 'countrycit')
write.csv(dff, "FinalStats.csv", row.names=FALSE, quote=FALSE)